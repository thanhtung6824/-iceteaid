{"version":3,"sources":["/home/admin1/Desktop/@iceteaid/packages/react-native/src/native-iframe.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { useState, useCallback } from 'react';\nimport { lastValueFrom } from 'rxjs';\nimport { Iframe, subjectBuilder, randomId, viewIsNotReady } from 'iceteaid-core';\nimport { StyleSheet, Platform, SafeAreaView } from 'react-native';\nimport { WebView } from 'react-native-webview';\nimport { RequestType } from 'iceteaid-type';\nimport { filter, take, tap } from 'rxjs/operators';\nimport { NativeTransporter } from './native-transporter';\n\nexport class NativeIframe extends Iframe<NativeTransporter> {\n    protected iframe: WebView | null = null;\n    protected view: any;\n    private googleLoginId = '';\n\n    // eslint-disable-next-line @typescript-eslint/no-empty-function\n    protected bootstrap(): void {\n    }\n\n    protected openIframe(): void  {\n        if (this.view) {\n            return this.view.openIframe();\n        }\n        throw viewIsNotReady();\n    }\n\n    protected closeIframe(): void {\n        if (this.view) {\n            return this.view.closeIframe();\n        }\n        throw viewIsNotReady();\n    }\n\n    public async postMessage(payload: string): Promise<void> {\n        const message = JSON.parse(payload);\n        if (message.requestType === RequestType.LOGIN_WITH_GOOGLE) {\n            this.view.openIframe();\n            this.googleLoginId = message.id;\n        }\n\n        (this.iframe as any).postMessage(payload);\n    }\n\n    public isReady(): Promise<any> {\n        return new Promise(async (resolve) => {\n            const id = randomId();\n            const subject = subjectBuilder(id, this.transporter.messageHandlers);\n            const timer = setInterval(async () => {\n                if (this.iframe) {\n                    (this.iframe as any).postMessage(JSON.stringify({\n                        id,\n                        payload: 'Are u ready?',\n                        requestType: RequestType.IS_READY,\n                    }));\n                    const isOkay = await lastValueFrom(subject.asObservable().pipe(\n                        filter(message => !!message),\n                        take(1),\n                        tap(() => {\n                            this.transporter.messageHandlers.delete(id);\n                        })\n                    ));\n                    if (isOkay) {\n                        clearInterval(timer);\n                        resolve(isOkay);\n                    }\n                }\n            }, 1000);\n        });\n    }\n\n    public handleWebViewNavigationStateChangeWrapper(newNavState: { url: any; canGoForward: any; }): void  {\n        const { url } = newNavState;\n        if (!url) return;\n        const returnUrl = new URL(url);\n        const urlParams = new URLSearchParams(returnUrl.search);\n        const credentials = urlParams.get('token');\n        const existUser = urlParams.get('existUser');\n        if (credentials && existUser && this.googleLoginId) {\n            const token = JSON.parse(credentials);\n            const subject = this.transporter.messageHandlers.get(this.googleLoginId);\n            subject.next({\n                payload: { token: token.access_token, existUser }, id: this.googleLoginId\n            });\n            this.googleLoginId = '';\n            this.view.closeIframe();\n        }\n    }\n\n    public IFrame: React.FC = () => {\n        const [open, setOpen] = useState(false);\n        const os = Platform.OS;\n        const webviewRef = useCallback((webView: any): void => {\n            this.iframe = webView;\n        }, []);\n\n        const openIframe = useCallback(() => {\n            setOpen(true);\n        }, []);\n\n        const closeIframe = useCallback(() => {\n            setOpen(false);\n        }, []);\n\n        const viewRef = useCallback((): void => {\n            this.view = {\n                openIframe,\n                closeIframe,\n            };\n        }, []);\n\n        const onMessage = (event: any) => {\n            this.transporter.handleMessage(event);\n        };\n\n        const handleWebViewNavigationStateChange = (newNavState: { url: any; canGoForward: any; }) => {\n            this.handleWebViewNavigationStateChangeWrapper(newNavState);\n        };\n\n        return (\n            <SafeAreaView\n                testID={'qwerty'}\n                ref={viewRef} style={[styles.container, open ? styles.showContainer : styles.hideContainer ]}>\n                <WebView\n                    testID={'abcxyz'}\n                    ref={webviewRef}\n                    startInLoadingState={true}\n                    javaScriptEnabled={true}\n                    source={{ uri: this.endpoint }}\n                    onMessage={onMessage}\n                    userAgent={\n                        os === 'ios' ?\n                            'Mozilla/5.0 (iPhone; CPU iPhone OS 10_3 like Mac OS X) AppleWebKit/603.1.23 (KHTML, like Gecko) Version/10.0 Mobile/14E5239e Safari/602' :\n                            'Mozilla/5.0 (Linux; Android 4.1.1; Galaxy Nexus Build/JRO03C) AppleWebKit/535.19 (KHTML, like Gecko) Chrome/18.0.1025.166 Mobile Safari/535.19'\n                    }\n                    onNavigationStateChange={handleWebViewNavigationStateChange}\n                />\n            </SafeAreaView>\n        );\n    };\n}\n\nconst styles = StyleSheet.create({\n    container: {\n        flex: 1,\n        width: '100%',\n        backgroundColor: 'transparent',\n        position: 'absolute',\n        top: 0,\n        left: 0,\n        right: 0,\n        bottom: 0,\n    },\n    webview: {\n        flex: 1,\n        backgroundColor: 'transparent',\n    },\n    showContainer: {\n        zIndex: 10000,\n        elevation: 10000,\n    },\n    hideContainer: {\n        zIndex: -10000,\n        elevation: -10000,\n    },\n    activityIndicatorStyle: {\n        flex: 1,\n        justifyContent: 'center',\n    },\n});\n"]}